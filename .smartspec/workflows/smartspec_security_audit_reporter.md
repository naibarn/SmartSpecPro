---
description: Generate security audit reports.
version: 6.0.0
workflow: /smartspec_security_audit_reporter
---

# smartspec_security_audit_reporter

> **Version:** 6.1.1  
> **Status:** Proposed  
> **Category:** quality

## Purpose

Generate a security audit report by correlating identified threats in `threats.md` with mitigation evidence in `tasks.md`, **validated against strict verification evidence** from `smartspec_verify_tasks_progress_strict` reports.

This is a **reports-only** workflow, safe to run locally or in CI. It does not modify any governed artifacts.

---

## Workflow Dependencies

This workflow is designed to run after:

1. `/smartspec_security_threat_modeler` (to generate `threats.md`)
2. `/smartspec_generate_tasks` (to generate `tasks.md` with mitigation tasks)
3. `/smartspec_verify_tasks_progress_strict` (to verify evidence for mitigation tasks)

---

## Governance contract

This workflow MUST follow:

- `knowledge_base_smartspec_handbook.md` (v6)
- `.spec/smartspec.config.yaml`

### Write scopes (enforced)

Allowed writes (safe outputs only):

- Reports: `.spec/reports/security-audit/**`

Forbidden writes (must hard-fail):

- Any path outside config `safety.allow_writes_only_under`
- Any path under config `safety.deny_writes_under`
- Any governed artifact (e.g., `specs/**`, `.spec/SPEC_INDEX.json`, `.spec/WORKFLOWS_INDEX.yaml`)
- Any runtime source tree modifications

### `--apply` behavior (universal flag)

- Accepted for compatibility but **ignored**. The workflow is reports-only.
- The report header MUST note that `--apply` was ignored if provided.

---

## Threat model (minimum)

This workflow must defend against:

- Path traversal / symlink escape when reading input files or writing reports.
- Secret leakage in the final audit report.
- Inaccurate audit results due to parsing errors or missing context files (`threats.md`, `tasks.md`).
- Spoofed or untrusted verification reports being treated as authoritative.
- Accidental network usage.

### Hardening requirements (MANDATORY)

- **No network access:** Respect `safety.network_policy.default=deny`.
- **No shell execution:** Do not run arbitrary commands from inputs.
- **Path normalization (reads + writes):** Reject traversal (`..`), absolute paths, and control characters on any user-supplied path.
- **No symlink escape (reads + writes):** Do not read/write through symlinks that resolve outside allowed scopes.
- **Read scope enforcement:** All file reads must remain within the project root.
- **Output root safety:** If `--out` is provided, it is a *requested* base output root and MUST:
  - resolve under config `safety.allow_writes_only_under`
  - not fall under config `safety.deny_writes_under`
  - not be a runtime source folder
  - hard-fail with usage/config error (`exit 2`) if invalid
- **Redaction:** Apply `safety.redaction` patterns to all report outputs.
- **Excerpt policy:** Do not paste large code/log dumps; reference file paths and IDs instead.
- **Output collision:** Respect `safety.output_collision` for report directories (never overwrite existing run folders).

---

## Invocation

### CLI

```bash
/smartspec_security_audit_reporter \
  <path/to/spec.md> \
  [--report-format <summary|detailed>] \
  [--verify-summary <path/to/verify-tasks-progress-strict/summary.json>] \
  [--out <output-root>] \
  [--json]
```

### Kilo Code

```bash
/smartspec_security_audit_reporter.md \
  specs/<category>/<spec-id>/spec.md \
  [--report-format detailed] \
  [--verify-summary .spec/reports/verify-tasks-progress-strict/<run-id>/summary.json] \
  [--out <output-root>] \
  [--json]
```

---

## Inputs

### Positional

- `spec_md` (required): Path to the `spec.md` file. The workflow will look for `threats.md` and `tasks.md` in the same directory.

### Implicit Context (Read-only)

- `.spec/reports/security-threat-model/**/threats.md`: Primary threat model input generated by `smartspec_security_threat_modeler`.
- `specs/**/tasks.md`: Used to find mitigation tasks linked to the threats.
- `.spec/reports/verify-tasks-progress-strict/**/summary.json`: Used as verification evidence (see Evidence selection).

### Input validation (MANDATORY)

- `spec_md` path must exist.
- The corresponding `threats.md` and `tasks.md` files MUST exist in the same directory, otherwise, the workflow fails with a usage error (`exit 2`).
- All user-supplied paths MUST reject traversal (`..`), absolute paths, and control characters.
- All paths must resolve within the project and not escape via symlinks.

---

## Flags

### Universal flags (must support)

- `--config <path>`
- `--lang <th|en>`
- `--platform <cli|kilo|ci|other>`
- `--apply` (ignored)
- `--out <path>`
- `--json`
- `--quiet`

### Workflow-specific flags

- `--report-format <summary|detailed>`: Controls the level of detail in `report.md`. Defaults to `detailed`.
- `--threats <path>`: Optional explicit path to a threat model `threats.md` under `.spec/reports/security-threat-model/**`. If provided, it is used as the **sole** threat source.
- `--verify-summary <path>`: Optional explicit path to a `smartspec_verify_tasks_progress_strict` `summary.json`. If provided, it is used as the **sole** verification evidence source.

---

## Threat model source selection and trust rules (MANDATORY)

Threats MUST be sourced from `smartspec_security_threat_modeler` outputs.

### If `--threats` is provided

- The workflow MUST use only that file.
- The workflow MUST validate it (see Threat source validation) and hard-fail (`exit 2`) if invalid/untrusted.

### If `--threats` is NOT provided (auto-select)

- Search under `.spec/reports/security-threat-model/**/threats.md`.
- The workflow MUST select the **latest deterministically**:
  - Prefer run folders whose name matches an ISO-like sortable run-id pattern: `YYYYMMDD-HHMMSSZ`.
  - Select the max lexicographic folder name among candidates that contain `threats.md`.
  - If no candidates match the sortable run-id pattern, hard-fail with `exit 2` and instruct to pass `--threats`.

### Threat source validation (MANDATORY)

A candidate `threats.md` is trusted only if:

- The file path resolves within project root and does not escape via symlinks.
- The file resides under `.spec/reports/security-threat-model/`.
- The file is non-empty and parses at least one threat ID (per `SAR-101`).

If any validation fails, the candidate MUST be rejected (not used).

---

## Evidence selection and trust rules (MANDATORY)

Verification evidence MUST come from `smartspec_verify_tasks_progress_strict` summary files.

### If `--verify-summary` is provided

- The workflow MUST use only that file.
- The workflow MUST validate it (see Evidence validation) and hard-fail (`exit 2`) if invalid/untrusted.

### If `--verify-summary` is NOT provided (auto-select)

- Search under `.spec/reports/verify-tasks-progress-strict/**/summary.json`.
- The workflow MUST validate candidate summaries (see Evidence validation).
- The workflow MUST select the **latest deterministically**:
  - Prefer summaries whose **parent folder name** matches an ISO-like sortable run-id pattern: `YYYYMMDD-HHMMSSZ`.
  - Select the max lexicographic folder name among valid candidates.
  - If no valid candidates match the sortable run-id pattern, hard-fail with `exit 2` and instruct to pass `--verify-summary`.

### Evidence validation (MANDATORY)

A candidate `summary.json` is trusted only if:

- `workflow == "smartspec_verify_tasks_progress_strict"`
- `version` is present
- `run_id` is present
- The file path resolves within project root and does not escape via symlinks

If any validation fails, the candidate MUST be rejected (not used).

---

## Mitigation linking contract (MANDATORY)

Threat-to-task correlation MUST be based on a **structured field**, not generic substring matching.

### Required format in `tasks.md`

Inside each task block, include a line:

- `Mitigates: T-001`  
  or
- `Mitigates: T-001, T-002, T-010`

Parsing rules:

- Threat IDs MUST match: `T-\d{3}`.
- The `Mitigates:` line MUST begin at line start (allowing optional indentation) to avoid accidental matches in prose.
- If a task references a threat ID anywhere else (not in a valid `Mitigates:` line), the workflow MAY emit a warning (`SAR-203 Weak Link`) but MUST NOT treat it as a valid mitigation link.

---

## Output structure

Outputs are always written under a run folder to prevent overwrites.

- Default root: `.spec/reports/security-audit/<run-id>/...`
- If `--out` is provided, it is treated as a *requested* base output root and MUST pass Output root safety validation; otherwise `exit 2`.

Artifacts:

- `report.md`
- `summary.json`

### Exit codes

- `0`: Audit complete; all threats are `Mitigated`.
- `1`: Audit complete; one or more threats are `Not Mitigated` or `Partially Mitigated`.
- `2`: Usage/config error (missing inputs, unsafe paths, no trusted evidence, invalid `--verify-summary`).

---

## Checks

Each check MUST emit a stable ID (`SAR-xxx`).

### Preflight safety checks (always enforced)

- **SAR-000 Preflight Safety**: Validate input paths, output root safety, and read/write constraints (path normalization + no symlink escape). Fail with `exit 2` on violation.
- **SAR-001 Evidence Trusted**: A trusted verification summary is available and passes Evidence validation. Fail with `exit 2` if none can be selected.

### MUST checks (affect threat status)

- **SAR-101 Threats Parsable**: `threats.md` is parsable and yields threat IDs.
- **SAR-102 Tasks Parsable**: `tasks.md` is parsable and yields task IDs.
- **SAR-103 Mitigation Links Parsed**: `Mitigates:` lines are parsed and linked to known threat IDs.
- **SAR-104 Verification Evidence Present**: For each mitigation task, evidence lookup can determine `verification_status` and `confidence` (best-effort; if missing, treat as not verified).

### SHOULD checks (warnings)

- **SAR-201 Unknown Threat ID in Tasks**: `Mitigates:` references a threat ID not present in `threats.md`.
- **SAR-202 Unlinked Threat**: Threat appears in `threats.md` but no mitigation tasks found.
- **SAR-203 Weak Link**: A threat reference was found outside a valid `Mitigates:` line (ignored for status).
- **SAR-204 Reduced Coverage**: Scan limits were reached; report reduced confidence.

---

## Core Logic

1. **Parse Inputs**: Load threats from the selected threat model `threats.md` (Threat model source selection) and tasks from `tasks.md` next to `spec.md`.
2. **Select Trusted Evidence**: Use `--verify-summary` if provided; otherwise auto-select deterministically (Evidence selection).
3. **Build Mitigation Map**: For each task, parse `Mitigates:` line(s) and map threat IDs â†’ task IDs.
4. **Verify Mitigation Evidence**: For each mitigation task, read verification evidence for the task ID. A task is considered verified only if:
   - `verification_status == "verified"` AND
   - `confidence == "high"`
5. **Determine Threat Status**:
   - **Mitigated**: All associated mitigation tasks are verified with high confidence.
   - **Partially Mitigated**: Some, but not all, associated tasks are verified.
   - **Not Mitigated**: No valid mitigation tasks found, or none verified.
6. **Generate Report**: Write `report.md` and `summary.json` under the run folder.

---

## `report.md` Artifact Structure

The generated report MUST include:

```markdown
# Security Audit Report for <Spec Title>

**Spec ID:** <spec-id>  
**Run ID:** <run-id>

## 1. Executive Summary

- **Overall Security Posture:** 8/10 Threats Mitigated (80%)
- **Unmitigated Threats:** 2
- **Evidence Source:** <verify-summary-path>
- **Key Finding:** While most threats have been addressed, critical risks related to [Category] remain outstanding.

## 2. Threat Mitigation Status

| Threat ID | Description | Category | Status |
| :-------- | :---------- | :------- | :----- |
| T-001 | User Impersonation | Spoofing | **Mitigated** |
| T-003 | CSRF on State-Changing APIs | Tampering | **Not Mitigated** |

## 3. Unmitigated / Partially Mitigated Threats

### T-003: CSRF on State-Changing APIs

- **Status:** Not Mitigated
- **Reason:** No valid mitigation task was found with a `Mitigates:` link.
- **Recommendation:** Create a mitigation task linked via `Mitigates: T-003` and re-run strict verify.

## 4. Evidence Appendix

- **T-001:** Verified via task `TSK-123-012` (Evidence: `<verify-summary-path>`)
```

---

## `summary.json` schema (minimum)

```json
{
  "workflow": "smartspec_security_audit_reporter",
  "version": "6.1.1",
  "run_id": "string",
  "status": "pass|fail",
  "scope": {
    "spec_id": "string",
    "spec_path": "string",
    "evidence_summary_path": "string"
  },
  "summary": {
    "total_threats": 0,
    "mitigated_count": 0,
    "partially_mitigated_count": 0,
    "unmitigated_count": 0
  },
  "threats": [
    {
      "threat_id": "T-003",
      "status": "Not Mitigated|Partially Mitigated|Mitigated",
      "reason": "string",
      "mitigation_tasks": ["TSK-123-012"],
      "evidence": {
        "verification_status": "verified|pending_evidence|unverified|unknown",
        "confidence": "high|medium|low|unknown"
      }
    }
  ],
  "warnings": [
    {"check_id": "SAR-203", "message": "string"}
  ],
  "writes": {"reports": ["path/to/report.md", "path/to/summary.json"]}
}
```

---

# End of workflow doc

