generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  tasks          Task[]
  testRuns       TestRun[]
  coverageRuns   CoverageRun[]
  securityChecks SecurityCheck[]
}

model Task {
  id               String   @id @default(cuid())
  sessionId         String
  session           Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  dedupeKey         String
  taskId            String?
  title             String
  originatingSpec   String?
  acceptanceCriteria String?
  mappedFiles       String[]
  mappedTests       String[]
  status            TaskStatus @default(planned)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([sessionId, dedupeKey], name: "sessionId_dedupeKey")
}

enum TaskStatus {
  planned
  doing
  done
  blocked
}

model TestRun {
  id         String   @id @default(cuid())
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  iteration  Int?
  passed     Boolean
  artifactKey String?
  summary    Json?
  createdAt  DateTime @default(now())
}

model CoverageRun {
  id         String   @id @default(cuid())
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  iteration  Int?
  percent    Float
  artifactKey String?
  summary    Json?
  createdAt  DateTime @default(now())
}

model SecurityCheck {
  id         String   @id @default(cuid())
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  iteration  Int?
  status     SecurityStatus @default(pass)
  artifactKey String?
  summary    Json?
  createdAt  DateTime @default(now())
}

enum SecurityStatus {
  pass
  fail
}
